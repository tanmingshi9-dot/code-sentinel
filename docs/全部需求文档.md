# 📘 Code-Sentinel: 企业级智能研发效能平台需求文档

| 文档版本 | V2.0 (全功能版) |
| :--- | :--- |
| **项目代号** | Code-Sentinel (代码哨兵) |
| **核心定位** | 集成 代码审查、安全风控、知识检索、效能度量 于一体的智能化研发中台。 |
| **技术底座** | Go-Zero, Kafka, K8s, PostgreSQL(Vector), Elasticsearch, LLM |

---

## 1. 核心业务流程与价值 (Business Value)

系统旨在解决研发团队的三大核心痛点：
1.  **人力瓶颈**：Senior 工程师没时间 Review 所有代码，导致烂代码入库。
2.  **规范不一**：不同项目组代码风格迥异，且安全规范（如密钥硬编码）难以强制落地。
3.  **知识断层**：新人难以理解历史代码逻辑，且文档更新滞后。

---

## 2. 详细功能需求 (Functional Requirements)

### 2.1 模块一：智能审查与风控 (Core Reviewer)
*此模块是系统的“心脏”，负责实时拦截低质量代码。*

#### F1.1 多模态代码审查 (Hybrid Code Review) `[P0]`
* **AI 深度审查**：利用 LLM 识别逻辑 Bug、性能隐患（如循环内查库）、代码异味。
* **[亮点] 增量审查 (Incremental Review)**：
    * 仅审查 PR 中**变更的代码**，而非全量文件。
    * 减少 Token 消耗，提升响应速度。
* **[亮点] 动态规则引擎 (Dynamic Rule Engine)**：
    * 支持读取项目根目录的 `.sentinel.yaml` 配置文件。
    * 支持在管理后台配置"企业级红线"（如：所有项目禁止使用 `MD5`）。
    * **规则市场**：预置常见规则包（Java 安全规范、Go 最佳实践、Python PEP8 等），支持社区贡献和共享。
    * **实现逻辑**：将通用 Prompt + 项目特定规则 + 企业红线 动态组装成最终 Prompt。
* **[亮点] 安全守门员 (Security Gatekeeper)**：
    * **Pre-LLM 扫描**：在调用 AI 前，先使用正则/AST 扫描代码。
    * **多维检测策略**：
        * 正则匹配：识别已知密钥格式（如 AWS Key 的 `AKIA` 前缀、GitHub Token 的 `ghp_` 前缀）。
        * 熵检测：对高熵字符串进行二次判断，识别 Base64 编码的密钥。
        * AST 分析：检测硬编码的敏感变量赋值。
    * **敏感阻断**：发现 AK/SK 密钥、内网 IP、私钥文件时，**直接阻断**流程并报警，不通过 AI（防止机密泄露给大模型厂商）。
* **[亮点] 多语言支持**：
    * **Phase 1**：Go、Java、Python
    * **Phase 2**：JavaScript/TypeScript、Rust、C/C++
    * 基于语言特性加载对应的 AST 解析器和规则集。

#### F1.2 误报反馈与自进化 (Feedback Loop) `[P1]`
* **交互式评论**：AI 在 GitHub 的评论下方附带指令（如 `回复 /false 标记误报`）。
* **Web UI 反馈入口**：管理后台提供可视化的反馈管理界面，降低使用门槛。
* **错题本机制**：
    * 用户标记误报后，系统将该代码片段 + 错误回答存入 Postgres。
    * **代码指纹关联**：记录代码的 AST 指纹，当代码结构变化时自动标记为"待复核"。
    * **有效期管理**：误报记录默认有效期 6 个月，过期自动归档，避免陈旧数据干扰。
    * **RAG 增强**：下次 Review 相似代码时，检索"错题本"，在 Prompt 中注入："注意，上次你在类似场景下犯过错，请避免..."。

#### F1.3 代码修复建议 (Auto-Fix Suggestion) `[P1]`
* **智能修复**：AI 不仅指出问题，还生成修复代码片段。
* **一键应用**：支持在 GitHub PR 中直接 Apply 修复建议（类似 GitHub Copilot）。
* **修复模板**：针对常见问题（空指针、SQL 注入、XSS）预置修复模板。

#### F1.4 自动生成测试 (Auto Test Generation) `[P2]`
* **单元测试生成**：AI 根据代码变更自动生成对应的单元测试。
* **测试覆盖分析**：检测 PR 中新增代码的测试覆盖率，未覆盖部分自动建议测试用例。
* **边界用例**：自动生成边界条件、异常场景的测试用例。

#### F1.5 PR ↔ Ticket 关联 (Requirement Traceability) `[P2]`
* **自动关联**：
    * 解析 PR 标题/描述/Commit Message 中的 Ticket ID（如 `JIRA-1234`、`#123`）。
    * 支持 Jira、飞书项目、Tapd、GitHub Issues 等主流平台。
* **需求验证**：
    * AI 读取 Ticket 中的需求描述和验收标准。
    * 对比 PR 代码变更，检查是否满足需求，未实现的验收点自动提醒。
* **状态同步**：PR 合并后自动更新 Ticket 状态为"已完成"，并回填 PR 链接。
* **覆盖度报告**：在效能大盘中展示需求完成情况和代码追溯关系。

### 2.2 模块二：代码知识库与 RAG (Knowledge Brain)
*此模块是系统的“大脑”，实现代码语义理解。*

#### F2.1 代码资产向量化 `[P1]`
* **增量同步**：监听 `Push` 事件，自动拉取最新代码。
* **智能切片**：
    * 基于 AST（抽象语法树）按函数/类进行切片，而非机械的按行切片。
    * **调用链分析**：关联上下游依赖代码，支持跨文件语义理解。
    * **大函数处理**：超过 200 行的函数按逻辑块二次切片。
* **双路存储**：
    * 向量存入 **pgvector**（用于语义搜），支持后续迁移至 Milvus/Qdrant。
    * 源码存入 **Elasticsearch**（用于关键词搜）。

#### F2.2 智能问答助手 `[P1]`
* 提供 Web 聊天界面，支持提问："用户登录的鉴权逻辑在哪里？"
* 系统通过**混合检索 (Hybrid Search)** 定位代码，并解释其逻辑。

#### F2.3 相似代码检测 (Similar Code Detection) `[P2]`
* **重复代码识别**：基于向量相似度检测代码库中的重复/相似代码片段。
* **复用建议**：发现相似实现时，推荐已有的公共方法或工具类，避免重复造轮子。
* **抄袭检测**：检测是否存在从外部复制的代码（如 Stack Overflow），提醒潜在的许可证风险。

#### F2.4 团队知识图谱 `[P2]`
* **代码归属分析**：基于 Git Blame 分析代码贡献者，建立"谁最懂这块代码"的映射。
* **专家推荐**：新人提问时自动推荐对接人，加速知识传递。
* **变更影响分析**：基于依赖图分析，预测本次变更可能影响的模块，辅助测试范围决策。

### 2.3 模块三：效能度量与报告 (Data Insights)
*此模块是系统的“报表”，面向管理层。*

#### F3.1 研发效能大盘 `[P2]`
* **Bug 类型分布**：利用 **Elasticsearch** 聚合分析，展示团队最爱犯哪类错误（如：30% 是空指针，20% 是 SQL 注入）。
* **代码健康度评分**：基于 AI 评分生成项目维度的健康度趋势图。

#### F3.2 智能周报 (Auto-Changelog) `[P2]`
* **CronJob 任务**：每周五自动触发。
* **自动生成**：汇总本周所有 PR 的 AI 摘要，生成人类可读的周报。
* **多渠道推送**：支持 Slack、钉钉、飞书、企业微信、邮件等。

### 2.4 模块四：CI/CD 集成 (DevOps Integration)
*此模块实现与现有研发流程的无缝对接。*

#### F4.1 流水线插件 `[P1]`
* **GitHub Action**：提供官方 Action，一行配置即可接入。
* **GitLab CI**：提供 `.gitlab-ci.yml` 模板。
* **Jenkins Plugin**：支持传统 CI 环境。

#### F4.2 PR 阻断策略 `[P1]`
* **严重问题自动 Block**：检测到安全漏洞或 P0 级问题时，自动阻止 Merge。
* **可配置阈值**：支持按项目配置阻断策略（如：仅阻断安全问题，不阻断代码风格问题）。
* **豁免机制**：支持 Tech Lead 手动豁免并记录原因。

---

## 3. 系统架构与组件映射 (Architecture & Components)

为了支撑上述功能，采用 **事件驱动微服务架构**。

### 3.1 流量接入层
* **Nginx**: HTTPS 卸载、静态资源服务、反向代理。
* **Go Gateway**: 
    * 接收 GitHub Webhook。
    * 负责 **Casdoor** 统一鉴权（管理后台登录）。
    * **Kafka Producer**: 将请求快速写入 Kafka `topic: git-events`。

### 3.2 核心计算层 (Consumer Group)
* **Go Analysis Service (核心消费者)**:
    * **Redis**: 
        * 分布式锁（防止重复分析）。
        * 限流（Rate Limiter，控制 Token 消耗）。
    * **Logic**: 执行“安全扫描 -> 规则加载 -> Prompt 组装 -> AI 调用 -> 评论回写”。
* **Go Knowledge Service**:
    * 负责代码切片、Embedding 调用、写入向量库。
* **LLM 适配层 (LLM Adapter)**:
    * **多模型支持**：OpenAI GPT-4、Claude、通义千问、本地部署模型（Ollama）。
    * **Fallback 策略**：主模型超时/失败时自动切换备用模型。
    * **成本控制**：按项目/团队配置 Token 配额，超额时降级或排队。
    * **私有化部署**：敏感项目可配置仅使用本地模型，数据不出内网。

### 3.3 数据存储层
* **PostgreSQL**:
    * `repos`: 仓库配置、动态规则。
    * `feedbacks`: 误报反馈数据（错题本），含代码指纹和有效期。
    * `code_vectors` (pgvector): 代码向量。
    * `rule_marketplace`: 规则市场数据。
* **Elasticsearch**:
    * `audit_logs`: 所有的 Review 记录（用于生成报表）。
    * `source_code`: 源码全文索引。
    * `code_graph`: 代码依赖关系图。

### 3.4 基础设施与可观测性
* **Kubernetes (K8s)**:
    * **HPA**: 监控 Kafka Lag + AI 响应延迟，自动扩容 Analysis Service Pod。
* **Prometheus + Grafana**: 监控 AI 接口耗时、Token 消耗成本、Bug 检出率、各模型调用量。
* **Jaeger**: 追踪 Webhook -> Kafka -> DB 的全链路耗时。
* **告警策略**：
    * Token 消耗超预算告警。
    * AI 响应延迟 > 30s 告警。
    * 安全拦截事件实时告警（钉钉/Slack）。

---

## 4. 实施路线图 (Implementation Roadmap)

### Phase 1: MVP 闭环 (单兵作战)
* **目标**：跑通 GitHub Webhook -> AI -> 评论。
* **功能**：
    * 基础代码审查（增量审查，仅分析变更代码）。
    * SQLite 存储基础配置。
    * 支持 Go/Java/Python 三种语言。
* **技术**：Go Gin, SQLite, Docker。

### Phase 2: 规则与存储 (战术升级)
* **目标**：支持自定义规则，防止敏感信息泄露。
* **功能**：引入 **Postgres** 存储规则，实现 **Security Gatekeeper** (正则拦截)。
* **技术**：引入 Postgres, Redis。

### Phase 3: RAG 与 知识库 (大脑升级)
* **目标**：让 AI 懂代码，能回答问题。
* **功能**：代码向量化入库，实现“错题本”反馈机制。
* **技术**：引入 pgvector, Elasticsearch。

### Phase 4: 企业级架构 (航母编队)
* **目标**：高并发、可观测、多租户。
* **功能**：微服务拆分，接入 **Kafka** 削峰，接入 **Casdoor** 登录，上线效能大盘。
* **技术**：Go-Zero, Kafka, K8s, Prometheus, Jaeger。

---