# ğŸ“ Code-Sentinel å¼€å‘è§„èŒƒ

| æ–‡æ¡£ç‰ˆæœ¬ | V1.0 |
| :--- | :--- |
| **é€‚ç”¨èŒƒå›´** | æ‰€æœ‰å‚ä¸é¡¹ç›®å¼€å‘çš„æˆå‘˜ |
| **ç”Ÿæ•ˆæ—¥æœŸ** | 2024-01-01 |

---

## 1. ç›®å½•ç»“æ„è§„èŒƒ

### 1.1 æ ‡å‡†ç›®å½•å¸ƒå±€

```
code-sentinel/
â”œâ”€â”€ cmd/                    # ç¨‹åºå…¥å£ï¼ˆä¿æŒç²¾ç®€ï¼‰
â”‚   â””â”€â”€ server/
â”‚       â””â”€â”€ main.go         # åªåšåˆå§‹åŒ–å’Œå¯åŠ¨
â”œâ”€â”€ internal/               # ç§æœ‰ä»£ç ï¼ˆä¸å¯¹å¤–æš´éœ²ï¼‰
â”‚   â”œâ”€â”€ config/            # é…ç½®ç›¸å…³
â”‚   â”œâ”€â”€ handler/           # HTTP è¯·æ±‚å¤„ç†
â”‚   â”œâ”€â”€ service/           # ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ model/             # æ•°æ®æ¨¡å‹
â”‚   â””â”€â”€ store/             # æ•°æ®å­˜å‚¨
â”œâ”€â”€ pkg/                    # å…¬å…±å·¥å…·åŒ…ï¼ˆå¯è¢«å¤–éƒ¨å¼•ç”¨ï¼‰
â”œâ”€â”€ configs/                # é…ç½®æ–‡ä»¶
â”œâ”€â”€ scripts/                # è„šæœ¬æ–‡ä»¶
â”œâ”€â”€ docs/                   # æ–‡æ¡£
â”œâ”€â”€ test/                   # æµ‹è¯•æ•°æ®/é›†æˆæµ‹è¯•
â””â”€â”€ web/                    # å‰ç«¯èµ„æºï¼ˆå¦‚æœ‰ï¼‰
```

### 1.2 ç›®å½•èŒè´£è¯´æ˜

| ç›®å½• | èŒè´£ | ç¦æ­¢ |
|------|------|------|
| `cmd/` | ç¨‹åºå…¥å£ | ç¦æ­¢å†™ä¸šåŠ¡é€»è¾‘ |
| `internal/handler/` | HTTP è¯·æ±‚å¤„ç†ã€å‚æ•°æ ¡éªŒ | ç¦æ­¢ç›´æ¥æ“ä½œæ•°æ®åº“ |
| `internal/service/` | ä¸šåŠ¡é€»è¾‘ | ç¦æ­¢ç›´æ¥å¤„ç† HTTP |
| `internal/store/` | æ•°æ®æŒä¹…åŒ– | ç¦æ­¢å†™ä¸šåŠ¡é€»è¾‘ |
| `pkg/` | é€šç”¨å·¥å…· | ç¦æ­¢ä¾èµ– internal |

---

## 2. ä»£ç è§„èŒƒ

### 2.1 å‘½åè§„èŒƒ

#### æ–‡ä»¶å‘½å
```
âœ… user_service.go      # å°å†™ + ä¸‹åˆ’çº¿
âœ… github.go            # å•è¯å°å†™
âŒ UserService.go       # ç¦æ­¢é©¼å³°
âŒ github-client.go     # ç¦æ­¢ä¸­åˆ’çº¿
```

#### åŒ…å‘½å
```go
âœ… package handler      // å°å†™å•è¯
âœ… package httputil     // å¤šè¯è¿å†™
âŒ package httpUtil     // ç¦æ­¢é©¼å³°
âŒ package http_util    // ç¦æ­¢ä¸‹åˆ’çº¿
```

#### å˜é‡/å‡½æ•°å‘½å
```go
// å¯¼å‡ºï¼ˆå…¬å¼€ï¼‰ï¼šå¤§é©¼å³°
func GetUserByID(id int) *User {}
type UserService struct {}

// ç§æœ‰ï¼šå°é©¼å³°
func getUserFromCache(id int) *User {}
var defaultTimeout = 30 * time.Second

// å¸¸é‡ï¼šå¤§é©¼å³°æˆ–å…¨å¤§å†™
const MaxRetryCount = 3
const DEFAULT_TIMEOUT = 30
```

#### æ¥å£å‘½å
```go
// æ¥å£ä»¥ -er ç»“å°¾ï¼ˆå•æ–¹æ³•æ¥å£ï¼‰
type Reader interface { Read() }
type Writer interface { Write() }

// å¤šæ–¹æ³•æ¥å£ç”¨åè¯
type Store interface {
    Create()
    Get()
    Update()
    Delete()
}
```

### 2.2 ä»£ç ç»„ç»‡

#### æ–‡ä»¶å†…é¡ºåº
```go
package xxx

// 1. importï¼ˆæ ‡å‡†åº“ã€ç¬¬ä¸‰æ–¹åº“ã€æœ¬é¡¹ç›®ï¼Œç©ºè¡Œåˆ†éš”ï¼‰
import (
    "context"
    "fmt"
    
    "github.com/gin-gonic/gin"
    "gorm.io/gorm"
    
    "code-sentinel/internal/model"
)

// 2. å¸¸é‡
const ()

// 3. å˜é‡
var ()

// 4. ç±»å‹å®šä¹‰
type Service struct {}

// 5. æ„é€ å‡½æ•°
func NewService() *Service {}

// 6. å…¬å¼€æ–¹æ³•ï¼ˆæŒ‰é‡è¦æ€§æ’åºï¼‰
func (s *Service) Create() {}
func (s *Service) Get() {}

// 7. ç§æœ‰æ–¹æ³•
func (s *Service) validate() {}
```

#### å‡½æ•°é•¿åº¦
- å•ä¸ªå‡½æ•°ä¸è¶…è¿‡ **80 è¡Œ**
- è¶…è¿‡åˆ™æ‹†åˆ†ä¸ºå¤šä¸ªç§æœ‰å‡½æ•°

#### å‚æ•°æ•°é‡
- å‡½æ•°å‚æ•°ä¸è¶…è¿‡ **5 ä¸ª**
- è¶…è¿‡åˆ™å°è£…ä¸ºç»“æ„ä½“

```go
// âŒ å‚æ•°è¿‡å¤š
func CreateUser(name, email, phone, address, city, country string) {}

// âœ… ä½¿ç”¨ç»“æ„ä½“
type CreateUserRequest struct {
    Name    string
    Email   string
    Phone   string
    Address string
}
func CreateUser(req *CreateUserRequest) {}
```

### 2.3 é”™è¯¯å¤„ç†

#### é”™è¯¯è¿”å›
```go
// âœ… é”™è¯¯ä½œä¸ºæœ€åä¸€ä¸ªè¿”å›å€¼
func GetUser(id int) (*User, error) {}

// âœ… ç«‹å³å¤„ç†é”™è¯¯
user, err := GetUser(id)
if err != nil {
    return nil, fmt.Errorf("get user failed: %w", err)
}

// âŒ ç¦æ­¢å¿½ç•¥é”™è¯¯
user, _ := GetUser(id)  // ç¦æ­¢
```

#### é”™è¯¯åŒ…è£…
```go
// âœ… ä½¿ç”¨ %w åŒ…è£…é”™è¯¯ï¼Œä¿ç•™é”™è¯¯é“¾
if err != nil {
    return fmt.Errorf("failed to create review: %w", err)
}

// âœ… æ·»åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯
if err != nil {
    return fmt.Errorf("failed to create review for PR #%d: %w", prNumber, err)
}
```

#### è‡ªå®šä¹‰é”™è¯¯
```go
// åœ¨ internal/errors/errors.go ä¸­å®šä¹‰
var (
    ErrNotFound     = errors.New("resource not found")
    ErrUnauthorized = errors.New("unauthorized")
    ErrInvalidInput = errors.New("invalid input")
)
```

### 2.4 æ—¥å¿—è§„èŒƒ

#### æ—¥å¿—çº§åˆ«
| çº§åˆ« | ä½¿ç”¨åœºæ™¯ |
|------|----------|
| `Debug` | å¼€å‘è°ƒè¯•ä¿¡æ¯ |
| `Info` | å…³é”®ä¸šåŠ¡æµç¨‹ |
| `Warn` | å¯æ¢å¤çš„å¼‚å¸¸ |
| `Error` | éœ€è¦å…³æ³¨çš„é”™è¯¯ |

#### æ—¥å¿—æ ¼å¼
```go
// âœ… ç»“æ„åŒ–æ—¥å¿—
logger.Info("PR review completed",
    zap.String("repo", repoName),
    zap.Int("pr_number", prNumber),
    zap.Duration("duration", duration),
)

// âŒ ç¦æ­¢å­—ç¬¦ä¸²æ‹¼æ¥
logger.Info("PR review completed for " + repoName)
```

#### æ•æ„Ÿä¿¡æ¯
```go
// âŒ ç¦æ­¢è®°å½•æ•æ„Ÿä¿¡æ¯
logger.Info("API Key: " + apiKey)

// âœ… è„±æ•å¤„ç†
logger.Info("API Key configured", zap.String("key_prefix", apiKey[:8]+"..."))
```

---

## 3. API è§„èŒƒ

### 3.1 RESTful è®¾è®¡

#### URL å‘½å
```
âœ… GET    /api/v1/repos              # è·å–åˆ—è¡¨
âœ… GET    /api/v1/repos/:id          # è·å–å•ä¸ª
âœ… POST   /api/v1/repos              # åˆ›å»º
âœ… PUT    /api/v1/repos/:id          # æ›´æ–°
âœ… DELETE /api/v1/repos/:id          # åˆ é™¤

âŒ GET    /api/v1/getRepos           # ç¦æ­¢åŠ¨è¯
âŒ POST   /api/v1/repo/create        # ç¦æ­¢åŠ¨è¯
```

#### å“åº”æ ¼å¼
```json
// æˆåŠŸå“åº”
{
    "code": 0,
    "message": "success",
    "data": { ... }
}

// é”™è¯¯å“åº”
{
    "code": 40001,
    "message": "invalid parameter",
    "detail": "repo_id is required"
}

// åˆ†é¡µå“åº”
{
    "code": 0,
    "message": "success",
    "data": {
        "items": [...],
        "total": 100,
        "page": 1,
        "page_size": 20
    }
}
```

### 3.2 é”™è¯¯ç è§„èŒƒ

| é”™è¯¯ç èŒƒå›´ | å«ä¹‰ |
|------------|------|
| 0 | æˆåŠŸ |
| 400xx | å®¢æˆ·ç«¯é”™è¯¯ï¼ˆå‚æ•°é”™è¯¯ï¼‰ |
| 401xx | è®¤è¯é”™è¯¯ |
| 403xx | æƒé™é”™è¯¯ |
| 404xx | èµ„æºä¸å­˜åœ¨ |
| 500xx | æœåŠ¡ç«¯é”™è¯¯ |

---

## 4. æ•°æ®åº“è§„èŒƒ

### 4.1 è¡¨å‘½å
```sql
âœ… repos              -- å¤æ•°å½¢å¼
âœ… review_records     -- ä¸‹åˆ’çº¿åˆ†éš”
âŒ Repo               -- ç¦æ­¢å¤§å†™
âŒ reviewRecords      -- ç¦æ­¢é©¼å³°
```

### 4.2 å­—æ®µå‘½å
```sql
âœ… created_at         -- ä¸‹åˆ’çº¿åˆ†éš”
âœ… repo_id            -- å¤–é”®ä»¥ _id ç»“å°¾
âŒ createdAt          -- ç¦æ­¢é©¼å³°
```

### 4.3 å¿…å¤‡å­—æ®µ
æ¯å¼ è¡¨å¿…é¡»åŒ…å«ï¼š
```sql
id          INTEGER PRIMARY KEY    -- ä¸»é”®
created_at  DATETIME              -- åˆ›å»ºæ—¶é—´
updated_at  DATETIME              -- æ›´æ–°æ—¶é—´
```

### 4.4 ç´¢å¼•è§„èŒƒ
- å¤–é”®å­—æ®µå¿…é¡»åŠ ç´¢å¼•
- å¸¸ç”¨æŸ¥è¯¢å­—æ®µåŠ ç´¢å¼•
- ç´¢å¼•å‘½åï¼š`idx_è¡¨å_å­—æ®µå`

```sql
CREATE INDEX idx_reviews_repo_id ON reviews(repo_id);
CREATE INDEX idx_reviews_created_at ON reviews(created_at);
```

---

## 5. Git è§„èŒƒ

### 5.1 åˆ†æ”¯å‘½å
```
main                    # ä¸»åˆ†æ”¯ï¼ˆä¿æŠ¤ï¼‰
develop                 # å¼€å‘åˆ†æ”¯
feature/xxx             # åŠŸèƒ½åˆ†æ”¯
bugfix/xxx              # ä¿®å¤åˆ†æ”¯
hotfix/xxx              # ç´§æ€¥ä¿®å¤
release/v1.0.0          # å‘å¸ƒåˆ†æ”¯
```

### 5.2 Commit è§„èŒƒ

é‡‡ç”¨ **Conventional Commits** æ ¼å¼ï¼š

```
<type>(<scope>): <subject>

<body>

<footer>
```

#### Type ç±»å‹
| Type | è¯´æ˜ |
|------|------|
| `feat` | æ–°åŠŸèƒ½ |
| `fix` | Bug ä¿®å¤ |
| `docs` | æ–‡æ¡£æ›´æ–° |
| `style` | ä»£ç æ ¼å¼ï¼ˆä¸å½±å“é€»è¾‘ï¼‰ |
| `refactor` | é‡æ„ |
| `test` | æµ‹è¯•ç›¸å…³ |
| `chore` | æ„å»º/å·¥å…·å˜åŠ¨ |

#### ç¤ºä¾‹
```
feat(webhook): add GitHub webhook signature verification

- Add HMAC-SHA256 signature verification
- Return 401 for invalid signatures
- Add unit tests

Closes #123
```

### 5.3 PR è§„èŒƒ

#### PR æ ‡é¢˜
```
feat(module): brief description
```

#### PR æè¿°æ¨¡æ¿
```markdown
## å˜æ›´è¯´æ˜
ç®€è¦æè¿°æœ¬æ¬¡å˜æ›´çš„å†…å®¹

## å˜æ›´ç±»å‹
- [ ] æ–°åŠŸèƒ½
- [ ] Bug ä¿®å¤
- [ ] é‡æ„
- [ ] æ–‡æ¡£æ›´æ–°

## æµ‹è¯•
- [ ] å·²æ·»åŠ å•å…ƒæµ‹è¯•
- [ ] å·²æœ¬åœ°æµ‹è¯•é€šè¿‡

## å…³è” Issue
Closes #xxx
```

---

## 6. æµ‹è¯•è§„èŒƒ

### 6.1 æµ‹è¯•æ–‡ä»¶å‘½å
```
xxx.go          # æºæ–‡ä»¶
xxx_test.go     # æµ‹è¯•æ–‡ä»¶ï¼ˆåŒç›®å½•ï¼‰
```

### 6.2 æµ‹è¯•å‡½æ•°å‘½å
```go
// å•å…ƒæµ‹è¯•
func TestFunctionName(t *testing.T) {}
func TestFunctionName_Scenario(t *testing.T) {}

// ç¤ºä¾‹
func TestParseGitDiff(t *testing.T) {}
func TestParseGitDiff_EmptyInput(t *testing.T) {}
func TestParseGitDiff_InvalidFormat(t *testing.T) {}
```

### 6.3 è¡¨é©±åŠ¨æµ‹è¯•
```go
func TestAdd(t *testing.T) {
    tests := []struct {
        name     string
        a, b     int
        expected int
    }{
        {"positive", 1, 2, 3},
        {"negative", -1, -2, -3},
        {"zero", 0, 0, 0},
    }
    
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            result := Add(tt.a, tt.b)
            if result != tt.expected {
                t.Errorf("Add(%d, %d) = %d, want %d", tt.a, tt.b, result, tt.expected)
            }
        })
    }
}
```

### 6.4 æµ‹è¯•è¦†ç›–ç‡
- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘è¦†ç›–ç‡ > **80%**
- å·¥å…·å‡½æ•°è¦†ç›–ç‡ > **90%**

---

## 7. é…ç½®è§„èŒƒ

### 7.1 é…ç½®æ–‡ä»¶
```yaml
# configs/config.yaml
server:
  host: 0.0.0.0
  port: 8080

database:
  driver: sqlite
  path: ./data/sentinel.db

github:
  # æ•æ„Ÿä¿¡æ¯ä½¿ç”¨ç¯å¢ƒå˜é‡
  app_id: ${GITHUB_APP_ID}
  private_key_path: ${GITHUB_PRIVATE_KEY_PATH}
```

### 7.2 ç¯å¢ƒå˜é‡
- æ•æ„Ÿä¿¡æ¯ï¼ˆAPI Keyã€å¯†ç ï¼‰å¿…é¡»ä½¿ç”¨ç¯å¢ƒå˜é‡
- ç¯å¢ƒå˜é‡å‘½åï¼š`CODE_SENTINEL_` å‰ç¼€ + å¤§å†™ä¸‹åˆ’çº¿

```bash
CODE_SENTINEL_GITHUB_APP_ID=123456
CODE_SENTINEL_OPENAI_API_KEY=sk-xxx
```

### 7.3 é…ç½®ç¤ºä¾‹æ–‡ä»¶
- æä¾› `config.example.yaml` ä½œä¸ºæ¨¡æ¿
- `.gitignore` ä¸­å¿½ç•¥çœŸå®é…ç½®æ–‡ä»¶

---

## 8. å®‰å…¨è§„èŒƒ

### 8.1 æ•æ„Ÿä¿¡æ¯
- âŒ ç¦æ­¢ç¡¬ç¼–ç  API Keyã€å¯†ç 
- âŒ ç¦æ­¢æäº¤æ•æ„Ÿä¿¡æ¯åˆ° Git
- âœ… ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–å¯†é’¥ç®¡ç†æœåŠ¡

### 8.2 è¾“å…¥æ ¡éªŒ
- æ‰€æœ‰å¤–éƒ¨è¾“å…¥å¿…é¡»æ ¡éªŒ
- ä½¿ç”¨å‚æ•°ç»‘å®šï¼Œç¦æ­¢æ‰‹åŠ¨æ‹¼æ¥ SQL

```go
// âœ… ä½¿ç”¨ GORM å‚æ•°ç»‘å®š
db.Where("id = ?", id).First(&user)

// âŒ ç¦æ­¢å­—ç¬¦ä¸²æ‹¼æ¥
db.Raw("SELECT * FROM users WHERE id = " + id)
```

### 8.3 Webhook å®‰å…¨
- å¿…é¡»éªŒè¯ GitHub Webhook ç­¾å
- ä½¿ç”¨ HTTPS

---

## 9. æ–‡æ¡£è§„èŒƒ

### 9.1 ä»£ç æ³¨é‡Š
```go
// Package service æä¾›æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å®ç°ã€‚
package service

// AnalyzerService è´Ÿè´£åè°ƒ PR ä»£ç å®¡æŸ¥æµç¨‹ã€‚
// åŒ…æ‹¬è·å– diffã€è°ƒç”¨ LLMã€å‘å¸ƒè¯„è®ºç­‰ã€‚
type AnalyzerService struct {}

// AnalyzePR åˆ†ææŒ‡å®šçš„ Pull Requestã€‚
//
// å‚æ•°:
//   - ctx: ä¸Šä¸‹æ–‡
//   - event: GitHub PR äº‹ä»¶
//
// è¿”å›:
//   - error: åˆ†æè¿‡ç¨‹ä¸­çš„é”™è¯¯
func (s *AnalyzerService) AnalyzePR(ctx context.Context, event *PREvent) error {}
```

### 9.2 README è§„èŒƒ
æ¯ä¸ªä¸»è¦ç›®å½•åº”åŒ…å« README.mdï¼Œè¯´æ˜ï¼š
- ç›®å½•èŒè´£
- ä¸»è¦æ–‡ä»¶è¯´æ˜
- ä½¿ç”¨ç¤ºä¾‹

---

## 10. Code Review æ£€æŸ¥æ¸…å•

æäº¤ PR å‰ï¼Œè¯·ç¡®è®¤ï¼š

### ä»£ç è´¨é‡
- [ ] ä»£ç ç¬¦åˆå‘½åè§„èŒƒ
- [ ] å‡½æ•°é•¿åº¦ < 80 è¡Œ
- [ ] æ— é‡å¤ä»£ç 
- [ ] é”™è¯¯éƒ½å·²å¤„ç†

### æµ‹è¯•
- [ ] æ–°å¢ä»£ç æœ‰å¯¹åº”æµ‹è¯•
- [ ] æµ‹è¯•å…¨éƒ¨é€šè¿‡
- [ ] æ—  lint è­¦å‘Š

### å®‰å…¨
- [ ] æ— ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯
- [ ] è¾“å…¥å·²æ ¡éªŒ
- [ ] æ—  SQL æ³¨å…¥é£é™©

### æ–‡æ¡£
- [ ] å…¬å¼€å‡½æ•°æœ‰æ³¨é‡Š
- [ ] å¤æ‚é€»è¾‘æœ‰è¯´æ˜
- [ ] README å·²æ›´æ–°ï¼ˆå¦‚éœ€è¦ï¼‰

---

## é™„å½•ï¼šå¸¸ç”¨å·¥å…·

### ä»£ç æ ¼å¼åŒ–
```bash
# æ ¼å¼åŒ–ä»£ç 
go fmt ./...

# æˆ–ä½¿ç”¨ goimportsï¼ˆæ¨èï¼‰
goimports -w .
```

### é™æ€æ£€æŸ¥
```bash
# ä½¿ç”¨ golangci-lint
golangci-lint run ./...
```

### æ¨è IDE æ’ä»¶
- **VS Code**: Go å®˜æ–¹æ’ä»¶
- **GoLand**: JetBrains å®˜æ–¹ IDE

---

> ğŸ“Œ **è§„èŒƒæ˜¯ä¸ºäº†å›¢é˜Ÿåä½œæ›´é¡ºç•…ï¼Œè€ŒéæŸç¼šã€‚å¦‚æœ‰æ›´å¥½çš„å»ºè®®ï¼Œæ¬¢è¿æå‡ºä¿®æ”¹ã€‚**
